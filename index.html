<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red Chilli</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src='//libtl.com/sdk.js' data-zone='10099787' data-sdk='show_10099787'></script>
    <script src="https://ad.gigapub.tech/script?id=3877"></script>
    
    <style>
        :root {
            --primary-blue: #007AFF; /* iOS-style blue */
            --primary-green: #34C759;
            --background-grey: #F2F2F7;
            --card-background: #FFFFFF;
            --text-dark: #000000;
            --text-light: #8A8A8E;
            --border-color: #E5E5EA;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            background-color: var(--background-grey); 
            color: var(--text-dark); 
        }
        .app-container { 
            max-width: 420px; 
            margin: 0 auto; 
            background-color: var(--background-grey); 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
        }
        
        /* --- Loading & Notice Styles (Unchanged) --- */
        .loading-screen, .welcome-notice-overlay { /* styles are kept from previous version */ }
        .loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #212529; display: flex; justify-content: center; align-items: center; z-index: 10000; transition: opacity 0.5s ease; }
        .loading-screen.fade-out { opacity: 0; }
        .loading-card { background-color: #343a40; color: white; padding: 30px; border-radius: 16px; text-align: center; width: 80%; max-width: 300px; }
        .loading-icon { width: 60px; height: 60px; margin: 0 auto 20px auto; border-radius: 50%; background: linear-gradient(45deg, #00ff87, #60efff); display: flex; justify-content: center; align-items: center; }
        .loading-icon svg { width: 30px; height: 30px; fill: white; }
        .loading-card h2 { margin: 0 0 8px 0; font-size: 1.2em; }
        .loading-card p { margin: 0 0 20px 0; font-size: 0.9em; color: #adb5bd; }
        .progress-bar { height: 4px; background-color: #495057; border-radius: 2px; overflow: hidden; }
        .progress-bar-inner { width: 40%; height: 100%; background-color: var(--primary-blue); animation: loading-animation 2s infinite; }
        @keyframes loading-animation { 0% { width: 0%; } 50% { width: 100%; } 100% { width: 0%; } }
        .welcome-notice-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 9990; padding: 20px; box-sizing: border-box; }
        .notice-card { background: var(--card-background); padding: 25px; border-radius: 15px; text-align: center; max-width: 350px; width: 100%; }
        .notice-card h3 { font-size: 1.6em; margin-bottom: 15px; }
        .notice-card p { color: var(--text-light); line-height: 1.6; font-size: 0.95em; }
        .notice-card ul { list-style-type: none; padding: 0; text-align: left; margin: 20px 0; font-size: 0.9em; }
        .notice-card ul li { margin-bottom: 8px; }
        .notice-card .rules { font-size: 0.85em; color: #dc3545; margin-top: 20px; font-style: italic; }

        /* --- Updated Main Styles --- */
        main { flex-grow: 1; padding: 16px 12px; overflow-y: auto; }
        h3 { font-size: 1.8em; font-weight: 700; margin: 0 0 16px 0; text-align: left; }
        header { 
            background-color: var(--background-grey); 
            padding: 15px; 
            border-bottom: none; 
        }
        .header-content { display: flex; align-items: center; justify-content: space-between; }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .user-photo img { border-radius: 50%; width: 50px; height: 50px; }
        .user-details { text-align: left; }
        .user-details h2 { 
            margin: 0; 
            font-size: 1.2em; 
            font-weight: 600; 
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .verified-badge {
            background-color: var(--primary-blue);
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            font-weight: bold;
        }
        .user-details #balance-display { margin: 4px 0 0 0; color: var(--text-light); font-weight: 500; font-size: 0.9em; }
        .page { display: none; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .card { 
            background-color: var(--card-background); 
            padding: 20px; 
            border-radius: 16px; 
            text-align: center; 
            border: none; 
            margin: 0 0 16px 0; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
        }
        .card h4 { margin: 12px 0 8px 0; font-size: 1.1em; font-weight: 600; }
        .card p { color: var(--text-light); line-height: 1.5; margin: 0 0 18px 0; font-size: 0.9em; }
        .card .task-info { font-size: 0.8em; color: var(--text-light); margin-top: 15px; }

        /* --- NEW Icon Wrapper Style --- */
        .icon-wrapper { 
            width: 50px; 
            height: 50px; 
            border-radius: 12px; /* Rounded Square */
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin: 0 auto 10px auto; 
        }
        .icon-wrapper.support { background-color: var(--primary-blue); }
        .icon-wrapper.video-camera { background-color: var(--primary-blue); }
        .icon-wrapper.telegram { background-color: #34B7F1; }
        .icon-wrapper.youtube { background-color: #FF3B30; }
        .icon-wrapper.facebook { background-color: #007AFF; }
        .icon-wrapper svg { width: 28px; height: 28px; fill: white; }

        .btn { 
            width: 100%; 
            padding: 14px; 
            border: none; 
            border-radius: 12px; 
            font-size: 1em; 
            cursor: pointer; 
            font-weight: 600; 
            background-color: var(--primary-blue); 
            color: white; 
            transition: transform 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        .button-group { display: flex; gap: 10px; margin-top: 0; }
        .button-group .btn { flex: 1; }

        /* --- NEW Nav Bar Style --- */
        nav { 
            display: flex; 
            justify-content: space-around; 
            padding: 8px 10px; 
            border-top: 1px solid var(--border-color); 
            background-color: var(--card-background); 
            position: sticky; 
            bottom: 0; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05); 
        }
        .nav-btn { 
            background: none; 
            border: none; 
            font-size: 0.75em; 
            color: var(--text-light); 
            cursor: pointer; 
            padding: 4px; 
            border-radius: 10px; 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 4px; 
            transition: all 0.2s ease;
        }
        .nav-btn.active { 
            background-color: var(--primary-blue); 
            color: white; 
        }
        .nav-btn .nav-icon { 
            width: 24px; 
            height: 24px; 
            fill: currentColor; 
        }
    </style>
</head>
<body>
    <div id="loading-screen" class="loading-screen">
        <!-- Loading screen content is unchanged -->
        <div class="loading-card">
            <div class="loading-icon"><svg viewBox="0 0 24 24"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg></div>
            <h2>Loading your dashboard...</h2><p>Securely syncing profile & config</p><div class="progress-bar"><div class="progress-bar-inner"></div></div>
        </div>
    </div>

    <div id="welcome-notice-overlay" class="welcome-notice-overlay" style="display: none;">
        <!-- Welcome notice content is unchanged -->
        <div class="notice-card">
            <h3 id="notice-title"></h3><div id="notice-greetings"></div><ul id="notice-details"></ul><ul id="notice-guarantees"></ul><p id="notice-rules" class="rules"></p><button id="notice-close-btn" class="btn btn-primary"></button>
        </div>
    </div>
    
    <div id="app-root" style="display: none;">
        <svg style="position: absolute; width: 0; height: 0; overflow: hidden;"><defs>
            <!-- Task Icons -->
            <symbol id="icon-video-camera" viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-event-l4 4v-11l-4 4z"/></symbol>
            <symbol id="icon-telegram" viewBox="0 0 24 24"><path d="M9.78 18.65l.28-4.23 7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3 3.62 11.95c-.8-.25-.79-.76.2-1l14.9-5.99c.68-.28 1.22.16 1.02.97l-2.66 12.55c-.28.84-1.01 1.05-1.72.63l-4.52-3.33-2.14 2.05c-.23.23-.42.42-.83.42z"/></symbol>
            <symbol id="icon-youtube" viewBox="0 0 24 24"><path d="M10 15V9l5.2 3-5.2 3zM12 5c-3.87 0-7 .31-7.82.44C3.32 5.67 2.66 6.33 2.43 7.19 2 8.75 2 12 2 12s0 3.25.43 4.81c.23.86.9 1.52 1.76 1.75C5.74 19 12 19 12 19s6.26 0 7.82-.44c.86-.23 1.52-.9 1.75-1.75.43-1.56.43-4.81.43-4.81s0-3.25-.42-4.81C21.34 6.33 20.68 5.67 19.82 5.44 18.26 5 12 5 12 5z"/></symbol>
            <symbol id="icon-facebook" viewBox="0 0 24 24"><path d="M14 13.5h2.5l1-4H14v-2c0-1.03 0-2 2-2h1.5V2.14c-.326-.043-1.557-.14-2.857-.14C11.928 2 10 3.657 10 6.7v2.8H7v4h3v8h4v-8z"/></symbol>
            <symbol id="icon-play-circle" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/></symbol>
            
            <!-- NEW Nav Icons -->
            <symbol id="nav-home" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></symbol>
            <symbol id="nav-support" viewBox="0 0 24 24"><path d="M11.5 2C6.81 2 3 5.81 3 10.5S6.81 19 11.5 19h.5v3c0 .55.45 1 1 1s1-.45 1-1v-3h.5c4.69 0 8.5-3.81 8.5-8.5S18.19 2 13.5 2h-2zm1 15c-3.86 0-7-3.14-7-7s3.14-7 7-7 7 3.14 7 7-3.14 7-7 7z"/><path d="M11 6h1v5h-1zm.5 6.5c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1z"/></symbol>
            <symbol id="nav-tasks" viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></symbol>
            <symbol id="nav-withdraw" viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></symbol>
        </defs></svg>
        
        <div class="app-container">
            <header>
                <div class="header-content">
                    <div class="header-left">
                        <div class="user-photo"><img id="user-photo" src="" alt="User"></div>
                        <div class="user-details">
                            <h2 id="user-name-container"><span id="user-name"></span><span class="verified-badge">‚úî</span></h2>
                            <p id="balance-display">‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: 0 ‡¶ü‡¶æ‡¶ï‡¶æ üí∞</p>
                        </div>
                    </div>
                </div>
            </header>
            <main id="main-content"></main>
            <nav>
                <button class="nav-btn active" data-page="home"><svg class="nav-icon"><use href="#nav-home"></use></svg>Home</button>
                <button class="nav-btn" data-page="support"><svg class="nav-icon"><use href="#nav-support"></use></svg>Support</button>
                <button class="nav-btn" data-page="tasks"><svg class="nav-icon"><use href="#nav-tasks"></use></svg>Tasks</button>
                <button class="nav-btn" data-page="withdraw"><svg class="nav-icon"><use href="#nav-withdraw"></use></svg>Withdraw</button>
            </nav>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        // --- All JavaScript logic from the previous final version remains unchanged ---
        // It will work perfectly with the new HTML and CSS.
        
        const firebaseConfig = {
            apiKey: "AIzaSyAIXpawpQH3yRozPbTzP7Tzm6IFsNVpAzQ",
            authDomain: "fake-earn-5d8bd.firebaseapp.com",
            databaseURL: "https://fake-earn-5d8bd-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "fake-earn-5d8bd",
            storageBucket: "fake-earn-5d8bd.firebasestorage.app",
            messagingSenderId: "763892818801",
            appId: "1:763892818801:web:ea1d0fe6a006616dbd8cd0"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        let currentUser;
        let appConfig;
        let userData = { balance: 0, referrals: 0, adsWatched: {}, claimedTasks: {} };
        let isFirstLoad = true;

        document.addEventListener('DOMContentLoaded', function () {
            const tg = window.Telegram.WebApp;
            if (tg.platform === 'unknown') {
                const loadingScreen = document.getElementById('loading-screen');
                loadingScreen.innerHTML = `<div class="full-page-notice"><div class="card"><h4>‚õî Access Denied</h4><p>Please open this app inside Telegram.</p></div></div>`;
                return;
            }
            tg.ready();
            tg.expand();
            tg.MainButton.hide();

            currentUser = tg.initDataUnsafe.user;
            if (!currentUser) {
                const loadingScreen = document.getElementById('loading-screen');
                loadingScreen.innerHTML = `<div class="full-page-notice"><div class="card"><h4>User data not found. Please restart.</h4></div></div>`;
                return;
            }

            loadConfigAndUserData();

            document.querySelectorAll('.nav-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    renderPage(button.dataset.page);
                });
            });
            
            document.getElementById('main-content').addEventListener('click', handleMainContentClick);
            
            document.getElementById('notice-close-btn').addEventListener('click', () => {
                document.getElementById('welcome-notice-overlay').style.display = 'none';
            });
        });

        function loadConfigAndUserData() {
            database.ref('config').once('value', (snapshot) => {
                if (snapshot.exists()) {
                    appConfig = snapshot.val();
                    initializeUser();
                } else {
                    document.getElementById('loading-screen').innerHTML = `<div class="card"><h4>App configuration not found.</h4></div>`;
                }
            }).catch(error => console.error("Config load error:", error));
        }
        
        function initializeUser() {
            const userRef = database.ref(`users/${currentUser.id}`);
            userRef.on('value', (snapshot) => {
                userData = snapshot.val() || { balance: 0, referrals: 0, adsWatched: {}, claimedTasks: {} };
                updateHeader();
                
                if (isFirstLoad) {
                    const currentPage = document.querySelector('.nav-btn.active')?.dataset.page || 'home';
                    renderPage(currentPage);
                    hideLoadingScreen();
                    isFirstLoad = false;
                }
            }, error => console.error("User data read error:", error));
            
            userRef.once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    userRef.set({ balance: 0, referrals: 0, adsWatched: {}, claimedTasks: {}, first_name: currentUser.first_name || '' })
                        .then(() => handleReferral());
                } else {
                    handleReferral();
                }
            });

            const userPhotoEl = document.getElementById('user-photo');
            document.getElementById('user-name').textContent = `${currentUser.first_name || ''} ${currentUser.last_name || ''}`.trim() || 'User';
            userPhotoEl.src = currentUser.photo_url || `https://via.placeholder.com/50/eeeeee/cccccc?text=${(currentUser.first_name || 'U').charAt(0)}`;
        }
        
        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loading-screen');
            loadingScreen.classList.add('fade-out');
            
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                document.getElementById('app-root').style.display = 'flex';
                showWelcomeNoticeIfNeeded();
            }, 500);
        }
        
        function showWelcomeNoticeIfNeeded() {
            const noticeConfig = appConfig.welcomeNotice;
            if (noticeConfig && noticeConfig.enabled) {
                const hasSeenNotice = localStorage.getItem('welcomeNoticeShown');
                if (!hasSeenNotice) {
                    document.getElementById('notice-title').textContent = noticeConfig.title || '';
                    document.getElementById('notice-greetings').innerHTML = (noticeConfig.greeting_lines || []).map(line => `<p>${line}</p>`).join('');
                    document.getElementById('notice-details').innerHTML = (noticeConfig.details_list || []).map(item => `<li>${item}</li>`).join('');
                    document.getElementById('notice-guarantees').innerHTML = (noticeConfig.guarantee_list || []).map(item => `<li>${item}</li>`).join('');
                    document.getElementById('notice-rules').textContent = noticeConfig.rules_line || '';
                    document.getElementById('notice-close-btn').textContent = noticeConfig.buttonText || 'Close';
                    
                    document.getElementById('welcome-notice-overlay').style.display = 'flex';
                    localStorage.setItem('welcomeNoticeShown', 'true');
                }
            }
        }

        function handleReferral() {
            const startParam = window.Telegram.WebApp.initDataUnsafe.start_param;
            if (!startParam || startParam === String(currentUser.id) || !appConfig) return;
            
            const referrerId = startParam;
            const newUserRef = database.ref(`users/${currentUser.id}`);

            newUserRef.child('referred_by').once('value', snapshot => {
                if (snapshot.exists()) return;
                newUserRef.child('referred_by').set(referrerId);
                const referrerRef = database.ref(`users/${referrerId}`);
                referrerRef.child('referrals').transaction(currentVal => (currentVal || 0) + 1);
                
                const referralBonus = appConfig.referralBonus || 0;
                if (referralBonus > 0) {
                    referrerRef.child('balance').transaction(currentBal => (currentBal || 0) + referralBonus);
                }
            }).catch(e => console.error("Referral check error:", e));
        }
        
        function updateHeader() {
            document.getElementById('balance-display').textContent = `‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: ${userData.balance || 0} ‡¶ü‡¶æ‡¶ï‡¶æ üí∞`;
        }
        
        function renderPage(pageName) {
            const mainContent = document.getElementById('main-content');
            if (!appConfig) { 
                mainContent.innerHTML = `<div class="card"><p>Loading...</p></div>`; return; 
            }
            let content = '';
            
            if (pageName === 'home') {
                 content = `<h3>Dashboard</h3><div class="card"><h4>Welcome Back!</h4><p>Complete your daily tasks and earn rewards.</p></div>`;
            } else if (pageName === 'support' && appConfig.supportPage) {
                const sp = appConfig.supportPage;
                content = `<h3>Support</h3>
                    <div class="card">
                        <div class="icon-wrapper support"><svg><use href="#icon-play-circle"></use></svg></div>
                        <h4>${sp.title}</h4>
                        <p>${sp.description}</p>
                        <button class="btn" data-action="open-url" data-url="${sp.videoUrl || '#'}">${sp.buttonText}</button>
                        <p class="task-info">${sp.notice}</p>
                    </div>`;
            } else if (pageName === 'tasks') {
                let tasksHtml = '<h3>Complete Tasks</h3>';
                if (appConfig.tasks && appConfig.tasks.length > 0) {
                    appConfig.tasks.forEach(task => {
                        if (task.enabled) {
                            const claimed = userData.claimedTasks || {};
                            const isClaimed = claimed[task.type];
                            let buttonsHtml = '';

                            if (task.type === 'ads') {
                                buttonsHtml = `<button class="btn" data-action="handleAd" data-reward="${task.reward || 0}">${task.buttons[0].text}</button>`;
                            } else {
                                buttonsHtml += '<div class="button-group">';
                                task.buttons.forEach(button => {
                                    let btnText = button.text;
                                    if (button.action === 'claim-task' && isClaimed) btnText = 'Claimed';
                                    buttonsHtml += `<button class="btn" data-action="${button.action}" data-url="${button.url || ''}" data-task-id="${task.type}" data-reward="${task.reward || 0}" ${isClaimed ? 'disabled' : ''}>${btnText}</button>`;
                                });
                                buttonsHtml += '</div>';
                            }
                            
                            tasksHtml += `<div class="card">
                                <div class="icon-wrapper ${task.icon}"><svg><use href="#icon-${task.icon}"></use></svg></div>
                                <h4>${task.title}</h4>
                                <p>${task.description}</p>
                                ${buttonsHtml}
                                <p class="task-info">${task.notice}</p>
                            </div>`;
                        }
                    });
                }
                content = tasksHtml;
            } else if (pageName === 'withdraw' && appConfig.withdrawPage) {
                const wp = appConfig.withdrawPage;
                const methods = (wp.methods || []).map(m => `<option value="${m}">${m}</option>`).join('');
                content = `<h3>Withdraw</h3><div class="card">
                    <p>${wp.noticeText || ''}</p>
                    <form class="withdraw-form" onsubmit="return false;">
                        <div class="form-group"><label>Method:</label><select id="withdraw-method">${methods}</select></div>
                        <div class="form-group"><label>Account Number:</label><input id="withdraw-account" type="text" placeholder="01XXXXXXXXX"></div>
                        <div class="form-group"><label>Amount (‡¶ü‡¶æ‡¶ï‡¶æ):</label><input id="withdraw-amount" type="number" placeholder="${wp.minAmount || 0}"></div>
                        <button type="submit" class="btn" data-action="submit-withdraw">Submit Request</button>
                    </form></div>`;
            } else {
                 content = `<h3>Home</h3><div class="card"><p>Page not found.</p></div>`;
            }
            mainContent.innerHTML = `<div class="page active">${content}</div>`;
        }

        function handleMainContentClick(event) {
            const button = event.target.closest('button[data-action]');
            if (!button) return;
            event.preventDefault();
            const action = button.dataset.action;

            if (action === 'submit-withdraw') handleWithdrawRequest();
            else if (action === 'handleAd') handleAdTask(parseFloat(button.dataset.reward) || 0);
            else if (action === 'open-url') window.Telegram.WebApp.openLink(button.dataset.url);
            else if (action === 'claim-task') handleClaimTask(button.dataset.taskId, parseFloat(button.dataset.reward), button);
        }

        function handleClaimTask(taskId, reward, claimButton) {
            if (!taskId || !reward) return;
            const claimedTasksRef = database.ref(`users/${currentUser.id}/claimedTasks/${taskId}`);
            claimedTasksRef.once('value', snapshot => {
                if (snapshot.exists()) {
                    window.Telegram.WebApp.showAlert("‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶á ‡¶™‡ßÅ‡¶∞‡¶∏‡ßç‡¶ï‡¶æ‡¶∞‡¶ü‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá‡¶á ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§");
                } else {
                    database.ref(`users/${currentUser.id}/balance`).transaction((bal) => (bal || 0) + reward);
                    claimedTasksRef.set(true);
                    window.Telegram.WebApp.showAlert(`‡¶Ö‡¶≠‡¶ø‡¶®‡¶®‡ßç‡¶¶‡¶®! ‡¶Ü‡¶™‡¶®‡¶ø ${reward} ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡ßÅ‡¶∞‡¶∏‡ßç‡¶ï‡¶æ‡¶∞ ‡¶™‡ßá‡ßü‡ßá‡¶õ‡ßá‡¶®‡•§`);
                    claimButton.disabled = true;
                    claimButton.textContent = 'Claimed';
                    const openButton = claimButton.closest('.button-group').querySelector('button[data-action="open-url"]');
                    if (openButton) openButton.disabled = true;
                }
            });
        }

        function handleWithdrawRequest() {
            const wp = appConfig.withdrawPage;
            const userBalance = userData.balance || 0;
            const amount = document.getElementById('withdraw-amount').value;
            if (Number(amount) < wp.minAmount) { window.Telegram.WebApp.showAlert(`‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ${wp.minAmount} ‡¶ü‡¶æ‡¶ï‡¶æ‡•§`); return; }
            if (Number(amount) > userBalance) { window.Telegram.WebApp.showAlert(`‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡ßá ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶®‡ßá‡¶á‡•§`); return; }
            window.Telegram.WebApp.showAlert('‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§');
        }
        
        async function handleAdTask(rewardAmount) {
            const today = new Date().toISOString().slice(0, 10);
            const adTaskConfig = appConfig.tasks.find(t => t.type === 'ads');
            const adsWatchedToday = userData.adsWatched?.[today] || 0;
            if (adsWatchedToday >= adTaskConfig.dailyLimit) {
                window.Telegram.WebApp.showAlert("‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶∏‡ßÄ‡¶Æ‡¶æ ‡¶Ö‡¶§‡¶ø‡¶ï‡ßç‡¶∞‡¶Æ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§"); return;
            }
            let adShownSuccessfully = false;
            try {
                const monetagShowFunction = window['show_10099787'];
                if (typeof monetagShowFunction === 'function') {
                    await monetagShowFunction();
                    adShownSuccessfully = true;
                }
            } catch (e) { console.warn("Ad error:", e); }
            if (adShownSuccessfully) {
                rewardUser("‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶®‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§", rewardAmount);
                database.ref(`users/${currentUser.id}/adsWatched/${today}`).transaction(val => (val || 0) + 1);
            } else {
                window.Telegram.WebApp.showAlert("‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§");
            }
        }
        
        function rewardUser(message, rewardAmount) {
            if (rewardAmount > 0) database.ref(`users/${currentUser.id}/balance`).transaction(bal => (bal || 0) + rewardAmount);
            window.Telegram.WebApp.showAlert(`‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶! ${message}${rewardAmount > 0 ? ` ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ${rewardAmount} ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡ßÅ‡¶∞‡¶∏‡ßç‡¶ï‡ßÉ‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§` : ''}`);
        }
    </script>
</body>
</html>
